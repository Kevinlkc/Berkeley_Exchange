"0","library(ATE)"
"0","data(""nhanes_bmi"")"
"0","z = nhanes_bmi$School_meal"
"0","y = nhanes_bmi$BMI"
"0","x = as.matrix(nhanes_bmi[, -c(1, 2)])"
"0","pscore = glm(z ~ x, family = binomial)$fitted.values"
"0","# Propensity Score Estimator"
"0","stat_SRE <- function(stratum, treatment, y){"
"0","  # Assume in our case that the stratum in arranged and indexed."
"0","  # If not, then re-code it to an index."
"0","  number = length(unique(stratum))"
"0","  tau = 0"
"0","  wil = 0"
"0","  r = 0"
"0","  # Calculate the three statistics as defined"
"0","  for (i in 1:number){"
"0","    tempy = y[stratum == i]"
"0","    tempt = treatment[stratum == i]"
"0","    n = length(tempy)"
"0","    pi = n/length(y)"
"0","    tau = tau + pi*(mean(tempy[tempt == 1] - mean(tempy[tempt == 0])))"
"0","    wil = wil + wilcox.test(tempy[tempt == 1], tempy[tempt == 0])$statistic / (n+1)"
"0","    tempy = tempy - mean(tempy)"
"0","  }"
"0","  y <- rank(y)"
"0","  for (i in 1:length(y)){"
"0","    if (treatment[i] == 1){"
"0","      r = r + y[i]"
"0","    }"
"0","  }"
"0","  return(c(taus = tau, wilcoxon = wil, alignedRank = r))"
"0","}"
"0","# Here we obtain the obs. values"
"0","tau_pSRE = c()"
"0","for (i in 1:7){"
"0","  stratum = floor(pscore*i) + 1"
"0","  obsValue <- stat_SRE(stratum, z, y)"
"0","  tau_pSRE = c(tau_pSRE, obsValue[1])"
"0","}"
"2","cannot compute exact p-value with ties"
"0","ggplot()+"
"0","  theme_bw() +"
"0","  geom_point(aes(x = 1:7, y = tau_pSRE), color = 'maroon', size = 2) +"
"0","  geom_line(aes(x = 1:7, y = tau_pSRE), color = 'maroon', size = 1)"
