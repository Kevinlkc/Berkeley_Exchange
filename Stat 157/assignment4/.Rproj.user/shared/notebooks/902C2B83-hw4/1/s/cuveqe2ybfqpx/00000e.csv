"0","data <- read.csv(""Visibility-Koch.csv"")"
"0","data <- subset(data, subset=c(repman==1 & voter==1))"
"0","data <- na.omit(data.full)"
"0","y = data$prcanid"
"0","z = 1 - data$rvisman"
"0","x = data %>%"
"0","  dplyr::select(""repcan1"", ""goppty"", ""rideo"", ""rproj"", ""repft"", ""aware"") %>%"
"0","  as.matrix"
"0","## analysis the randomized experiment via"
"0","# Lin's Estimator"
"0","xc = scale(x)"
"0","linols = lm(y ~ z + xc + z*xc)"
"0","tau_Lin = linols$coefficients[2]"
"0","round(summary(linols)$coef[2, ], 4)"
"1","  Estimate "
"1","Std. Error "
"1","   t value "
"1","  Pr(>|t|) "
"1","
"
"1","   -0.0251 "
"1","    0.0602 "
"1","   -0.4168 "
"1","    0.6769 "
"1","
"
"0","sqrt(hccm(linols)[2, 2])"
"1","[1]"
"1"," 0.05782918"
"1","
"
"0","# Regression Imputation Shall return the same results as Lin"
"0","model1 = lm(y[z == 1]~x[z == 1,])"
"0","model0 = lm(y[z == 0]~x[z == 0,])"
"0","tau_reg = mean(cbind(1, x) %*% model1$coefficients - cbind(1, x) %*% model0$coefficients)"
"0","# Propensity score stratification"
"0","pscore = glm(z ~ x, family = binomial)$fitted.values"
"0","tau_pSRE = c()"
"0","for (i in 2:5){"
"0","  stratum = floor(pscore*i) + 1"
"0","  obsValue <- stat_SRE(stratum, z, y)"
"0","  tau_pSRE = c(tau_pSRE, obsValue[1])"
"0","}"
"0","tau_pSRE"
"1","        taus "
"1","        taus "
"1","        taus "
"1","        taus "
"1","
"
"1"," 0.028850929 "
"1"," 0.007541221 "
"1","         NaN "
"1","-0.006391974 "
"1","
"
"0","# IPW estimator"
"0","# With no truncation"
"0","truncpscore = c(0,1)"
"0","pscore = glm(z ~ x, family = binomial)$fitted.values"
"0","pscore = pmax(truncpscore[1], pmin(truncpscore[2], pscore))"
"0","ipw_1 = mean(z*y/pscore - (1 - z)*y/(1 - pscore))"
"0","ipw_hajek_1 = mean(z*y/pscore)/mean(z/pscore) - mean((1 - z)*y/(1 - pscore))/mean((1 - z)/(1 - pscore))"
"0","# With certain truncation"
"0","truncpscore = c(0.1,0.9)"
"0","pscore = glm(z ~ x, family = binomial)$fitted.values"
"0","pscore = pmax(truncpscore[1], pmin(truncpscore[2], pscore))"
"0","ipw_2 = mean(z*y/pscore - (1 - z)*y/(1 - pscore))"
"0","ipw_hajek_2 = mean(z*y/pscore)/mean(z/pscore) - mean((1 - z)*y/(1 - pscore))/mean((1 - z)/(1 - pscore))"
"0","# Doubly Robust Estimator"
"0","outcome1 = glm(y ~ x, weights = z, family = gaussian)$fitted.values"
"0","outcome0 = glm(y ~ x, weights = (1 - z), family = gaussian)$fitted.values"
"0","res1 = y - outcome1"
"0","res0 = y - outcome0"
"0","tau_dr = mean(outcome1 - outcome0) + mean(z*res1/pscore - (1 - z)*res0/(1 - pscore))"
"0","print(paste(""Lin's estimator is "", tau_Lin, sep = """"))"
"1","[1]"
"1"," ""Lin's estimator is -0.0250891102390644"""
"1","
"
"0","print(paste(""Regression Imputation gives us an estimate same as Lin's "", tau_reg, sep = """"))"
"1","[1]"
"1"," ""Regression Imputation gives us an estimate same as Lin's -0.025089110239063"""
"1","
"
"0","# Note that there could be Na values as stratums of pscores might not always include enough control and treatment observations"
"0","print(paste(""pscore stratification's estimator is "", tau_pSRE, sep = """"))"
"1","[1]"
"1"," ""pscore stratification's estimator is 0.028850928914995""   "
"1","
"
"1","[2]"
"1"," ""pscore stratification's estimator is 0.00754122081333689"" "
"1","
"
"1","[3]"
"1"," ""pscore stratification's estimator is NaN""                 "
"1","
"
"1","[4]"
"1"," ""pscore stratification's estimator is -0.00639197365510275"""
"1","
"
"0","print(paste(""IPW estimator (hovic-thompson) without truncation is "",ipw_1, "" and the hajek estimator is "",ipw_hajek_1 ,sep = """"))"
"1","[1]"
"1"," ""IPW estimator (hovic-thompson) without truncation is -0.142357535224816 and the hajek estimator is -0.0221982873378366"""
"1","
"
"0","print(paste(""IPW estimator (hovic-thompson) with truncation is "",ipw_2, "" and the hajek estimator is "",ipw_hajek_2 ,sep = """"))"
"1","[1]"
"1"," ""IPW estimator (hovic-thompson) with truncation is -0.178563422656618 and the hajek estimator is -0.016432858686283"""
"1","
"
"0","print(paste(""The doubly robust estimator is "", tau_dr))"
"1","[1]"
"1"," ""The doubly robust estimator is  -0.0394785911682918"""
"1","
"
